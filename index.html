<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <meta property="og:image" content="http://dscain.github.io/tarifa-teste/images/octocat-icon.png" />
    <meta property="og:title" content="title of the page" />
    <meta property="og:description"content="hgfhbhbadd a short description of the page or content"/>
    <title></title>
    <link href="stylesheets/site.css" rel="stylesheet" />
    <script src="scripts/jquery-1.10.1.js"></script>
    <script src="scripts/jquery-ui.js"></script>
    <script src="scripts/jquery.cookie.js"></script>
</head>
<body>
     <div id="body">
        <div class="expli">A passagem de ônibus é</div>
        <b>
            <p style="font-size: 40px;">
                R$<span style="display: inline-block; vertical-align: middle; font-size: 70px; margin-top: -10px;">2.85</span>
            </p>
        </b>
        <div class="expli">
            Vamos fazer um teste
        <br />
            se nosso governo decidisse:
        </div>
        <input type="checkbox" id="opImpostoTarifa" class="opcao" /><label for="opImpostoTarifa" title="Reduz a passagem em R$0,15" tarifareducao="0.15" opcao="1">Isentar impostos</label>
        <br />
        <input type="checkbox" id="opSistemaAutomatizado" class="opcao" /><label for="opSistemaAutomatizado" title="Reduz a passagem em R$0,25" tarifareducao="0.25" opcao="2">Implementar sistema automatizado sem cobradores</label>
        <br />
        <input type="checkbox" id="opRetirarIsencoes" class="opcao" /><label for="opRetirarIsencoes" title="Reduz a passagem em R$0,35" tarifareducao="0.35" opcao="3">Retirar isenções</label>
        <br />
        <input type="checkbox" id="opRetirarDescontoEstudante" class="opcao" /><label for="opRetirarDescontoEstudante" title="Reduz a passagem em R$0,25" tarifareducao="0.45" opcao="4">Retirar desconto de estudante</label>
        <br />
        <input type="checkbox" id="opArCondicionado" class="opcao" /><label for="opArCondicionado" title="Reduz a passagem em R$0,25" tarifareducao="0.55" opcao="5">Instalar ar-condicionado em todos os carros</label>
        <br />
        <input type="checkbox" id="opRetirarDiaDePasseLivre" class="opcao" /><label for="opRetirarDiaDePasseLivre" title="Reduz a passagem em R$0,25" tarifareducao="0.65" opcao="6">Retirar o dia do passe livre</label>
        <br />
        <input type="checkbox" id="opRetirarPassagemIntegrada" class="opcao" /><label for="opRetirarPassagemIntegrada" title="Reduz a passagem em R$0,25" tarifareducao="0.75" opcao="7">Retirar a passagem integrada</label>
        <br />
        <input type="checkbox" id="opRetirarLucroDasEmpresas" class="opcao" /><label for="opRetirarLucroDasEmpresas" title="Reduz a passagem em R$0,35" tarifareducao="0.85" opcao="7">Tirar lucro das empresas</label>
        <br />
        <div class="expli">A passagem fica</div>
        <b>
            <p style="font-size: 40px;">
                R$<span id="tarifaFinal" style="display: inline-block; vertical-align: middle; font-size: 70px; margin-top: -10px;">2.85</span>
            </p>
        </b>
        <a id="linkShare" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fparse.com" target="_blank">Share on Facebook
        </a>
    </div>
    <script>
        $(document).ready(function () {
            if (!$.cookie('ui')) {
                var uiRandom = Math.floor((Math.random() * 1000 * 1000 * 1000 * 1000 * 1000) + 1);;
                $.cookie('ui', uiRandom);
            } 
            ui = $.cookie('ui');

            $('.opcao').button().click(function () {
                tarifaFinalUpdate();
            });
        });

        function tarifaFinalUpdate() {
            var sum = 0;
            var opcoes = [0];
            $('.ui-state-active').each(function () {
                var b = $($(this)[0]);
                sum += Number(b.attr("tarifaReducao"));
                opcoes.push(b.attr("opcao"));
            });
            var tarifaFinal = formatnum(2.85 - sum);
            $("#tarifaFinal").html(tarifaFinal);
            
            var urlParam = generateFacebookShareLink(opcoes);
            $("#linkShare").attr("href", urlParam);

            return;
            $.ajax({
                url: 'http://localhost:17465/api/values/5',
                type: 'PUT',
                contentType: 'application/x-www-form-urlencoded; charset=utf-8',
                data: '=' + encodeURIComponent(opcoes.join(',')),
                success: function (data) {
                },
                error: function (result) {
                    if (console) {
                        console.log(result);
                    }
                }
            });
        }

        function formatnum(num) {
            var cents = parseInt((num - parseInt(num)) * 100);
            var inteiro = parseInt(num - cents / 100);
            var zero = String(cents).length == 1 ? cents + '0' : cents;

            if (inteiro < 0 || cents < 0) {
                return "0.00";
            }

            return inteiro + '.' + cents;
        }

        var ui, proposta;
        function generateFacebookShareLink(paramProposta, paramUi) {
            var paramPropostab64 = btoa(paramProposta);
            var paramUi = btoa(paramUi);

            var urlBase = "http://dscain.github.io/tarifa-teste/index.html?";
            var url = urlBase + "p=" + paramPropostab64 + "&u=" + ui;
            var urlUriEncoded = encodeURIComponent(url);
            var finalUrl = "https://www.facebook.com/sharer/sharer.php?u=" + urlUriEncoded;
            console.log(finalUrl + " em " + url);
            return finalUrl;
        }
    </script>
</body>
</html>
